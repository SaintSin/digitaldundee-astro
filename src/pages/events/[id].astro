---
import { Image } from 'astro:assets';
import { getCollection, render } from 'astro:content';
import Layout from '@layouts/BaseLayout.astro';
import {
  digitalDundeeOrganization,
  generateBreadcrumbs,
  BREADCRUMB_LABELS,
  SITE_URL,
} from '@utils/schema';
import type { Event as EventSchema, Place } from '@types';
import type { GetStaticPaths } from 'astro';

export const getStaticPaths = (async () => {
  const events = await getCollection('events');
  return events.map((event) => ({
    params: { id: event.id },
    props: { event },
  }));
}) satisfies GetStaticPaths;

const { event } = Astro.props;
const {
  title,
  eventDate,
  eventEndDate,
  eventStartTime,
  eventEndTime,
  location,
  eventUrl,
  imagePrimary,
} = event.data;

// Format date
const formatDate = (date: Date) => {
  return new Intl.DateTimeFormat('en-GB', {
    weekday: 'long',
    day: 'numeric',
    month: 'long',
    year: 'numeric',
  }).format(date);
};

// Build location schema if we have location data
const eventLocation: Place | string = location || 'Dundee, Scotland';

const eventSchema: EventSchema = {
  '@context': 'https://schema.org',
  '@type': 'Event',
  name: title,
  description: event.data.description || `Learn more about ${title}`,
  startDate: eventDate.toISOString(),
  endDate: eventEndDate?.toISOString(),
  location: eventLocation,
  organizer: digitalDundeeOrganization,
  url: eventUrl || `${SITE_URL}/events/${event.id}`,
  eventStatus: 'https://schema.org/EventScheduled',
  eventAttendanceMode: 'https://schema.org/OfflineEventAttendanceMode',
};

const meta = {
  title: title,
  description: event.data.description || `Learn more about ${title}`,
  imageOG: imagePrimary?.src
    ? imagePrimary.src.src
    : 'generic-social-1200x630.png',
  altOG: imagePrimary?.alt || title,
  schema: [digitalDundeeOrganization, eventSchema],
};

const { Content } = await render(event);
---

<Layout metaData={meta}>
  <main class="wrapper flow">
    <article>
      <header>
        {
          imagePrimary && (
            <Image src={imagePrimary.src} alt={imagePrimary.alt} />
          )
        }
        <h1>{title}</h1>

        <time datetime={eventDate.toISOString()}>
          {formatDate(eventDate)}
          {eventStartTime && ` - ${eventStartTime}`}
          {eventEndTime && ` to ${eventEndTime}`}
        </time>

        {location && <p>{location}</p>}

        {
          eventUrl && (
            <a href={eventUrl} target="_blank" rel="noopener noreferrer">
              Event Website
            </a>
          )
        }
      </header>

      <Content />

      <a href="/events">Back to Events</a>
    </article>
  </main>
</Layout>
