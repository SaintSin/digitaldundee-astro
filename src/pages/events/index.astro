---
import { getCollection } from 'astro:content';
import Breadcrumbs from '@components/Breadcrumbs.astro';
import EventCard from '@components/cards/Event.astro';
import Hero from '@components/Hero.astro';
import Pagination from '@components/Pagination.astro';
import header from '@images/header/events.jpg';
import Layout from '@layouts/BaseLayout.astro';
import type { CollectionPage } from '@types';
import { DEFAULT_PAGE_SIZE, getPaginatedMeta } from '@utils/pagination';
import {
  BREADCRUMB_LABELS,
  digitalDundeeOrganization,
  generateBreadcrumbs,
} from '@utils/schema';

const events = await getCollection('events');
const now = new Date();

// Split into forthcoming and previous events
const forthcomingEvents = events
  .filter((event) => new Date(event.data.eventDate) >= now)
  .sort((a, b) => a.data.eventDate.getTime() - b.data.eventDate.getTime());

const previousEvents = events
  .filter((event) => new Date(event.data.eventDate) < now)
  .sort((a, b) => b.data.eventDate.getTime() - a.data.eventDate.getTime());

// Combine for pagination (forthcoming first, then previous)
const sortedEvents = [...forthcomingEvents, ...previousEvents];

// Paginate manually for the first page
const totalPages = Math.ceil(sortedEvents.length / DEFAULT_PAGE_SIZE);
const firstPageData = sortedEvents.slice(0, DEFAULT_PAGE_SIZE);

// Split firstPageData back into forthcoming and previous for display
const firstPageForthcoming = firstPageData.filter(
  (event) => new Date(event.data.eventDate) >= now,
);
const firstPagePrevious = firstPageData.filter(
  (event) => new Date(event.data.eventDate) < now,
);

const collectionPageSchema: CollectionPage = {
  '@context': 'https://schema.org',
  '@type': 'CollectionPage',
  name: 'Events',
  description: 'Discover upcoming and past events in Digital Dundee',
  url: `${digitalDundeeOrganization.url}/events`,
  breadcrumb: generateBreadcrumbs(Astro.url.pathname, BREADCRUMB_LABELS),
};

const meta = {
  ...getPaginatedMeta(
    'Events',
    'Discover upcoming and past events in Digital Dundee',
    1,
    'generic-social-1200x630.png',
    'Digital Dundee Events',
  ),
  schema: [digitalDundeeOrganization, collectionPageSchema],
};
---

<Layout metaData={meta}>
  <Hero title="Events" image={header} alt="About page header" />

  <main class="wrapper flow">
    <Breadcrumbs />

    {
      firstPageForthcoming.length > 0 && (
        <section>
          <h2>Forthcoming Events</h2>
          <div class="grid" data-layout="thirds">
            {firstPageForthcoming.map((event) => (
              <EventCard
                title={event.data.title}
                eventDate={event.data.eventDate}
                eventEndDate={event.data.eventEndDate}
                eventStartTime={event.data.eventStartTime}
                eventEndTime={event.data.eventEndTime}
                location={event.data.location}
                imageSrc={event.data.imagePrimary?.src}
                imageAlt={event.data.imagePrimary?.alt || event.data.title}
                href={`/events/${event.id}`}
              />
            ))}
          </div>
        </section>
      )
    }

    {
      firstPagePrevious.length > 0 && (
        <section>
          <h2>Previous Events</h2>
          <div class="grid" data-layout="thirds">
            {firstPagePrevious.map((event) => (
              <EventCard
                title={event.data.title}
                eventDate={event.data.eventDate}
                eventEndDate={event.data.eventEndDate}
                eventStartTime={event.data.eventStartTime}
                eventEndTime={event.data.eventEndTime}
                location={event.data.location}
                imageSrc={event.data.imagePrimary?.src}
                imageAlt={event.data.imagePrimary?.alt || event.data.title}
                href={`/events/${event.id}`}
              />
            ))}
          </div>
        </section>
      )
    }

    {firstPageData.length === 0 && <p>No events found.</p>}

    {
      totalPages > 1 && (
        <Pagination
          currentPage={1}
          totalPages={totalPages}
          baseUrl="/events"
          nextUrl={totalPages > 1 ? '/events/2' : undefined}
        />
      )
    }
  </main>
</Layout>
