---
import { getCollection } from 'astro:content';
import Breadcrumbs from '@components/Breadcrumbs.astro';
import NewsCard from '@components/cards/News.astro';
import Hero from '@components/Hero.astro';
import Pagination from '@components/Pagination.astro';
import header from '@images/header/news.jpg';
import Layout from '@layouts/BaseLayout.astro';
import type { CollectionPage } from '@types';
import {
  DEFAULT_PAGE_SIZE,
  getPaginatedMeta,
  sortByDateDesc,
} from '@utils/pagination';
import {
  BREADCRUMB_LABELS,
  digitalDundeeOrganization,
  generateBreadcrumbs,
} from '@utils/schema';
import type { GetStaticPaths, Page } from 'astro';

export const getStaticPaths = (async ({ paginate }) => {
  const news = await getCollection('news');
  const sortedNews = sortByDateDesc(news);

  return paginate(sortedNews, {
    pageSize: DEFAULT_PAGE_SIZE,
  });
}) satisfies GetStaticPaths;

interface Props {
  page: Page;
}

const { page } = Astro.props;

const collectionPageSchema: CollectionPage = {
  '@context': 'https://schema.org',
  '@type': 'CollectionPage',
  name: 'News',
  description: 'Latest news and updates from Digital Dundee',
  url: `${digitalDundeeOrganization.url}/news`,
  breadcrumb: generateBreadcrumbs(Astro.url.pathname, BREADCRUMB_LABELS),
};

const meta = {
  ...getPaginatedMeta(
    'News',
    'Latest news and updates from Digital Dundee',
    page.currentPage,
    'generic-social-1200x630.png',
    'Digital Dundee News',
  ),
  schema: [digitalDundeeOrganization, collectionPageSchema],
};
---

<Layout metaData={meta}>
  <Hero title="News" image={header} alt="News page header" />

  <main class="wrapper flow">
    <Breadcrumbs />

    {
      page.data.length > 0 ? (
        <>
          <section class="grid" data-layout="thirds">
            {page.data.map((item) => (
              <NewsCard
                title={item.data.title}
                excerpt={item.data.excerpt}
                pubDate={item.data.pubDate}
                imageSrc={item.data.imagePrimary.src}
                imageAlt={item.data.imagePrimary.alt}
                href={`/news/${item.id}`}
              />
            ))}
          </section>

          <Pagination
            currentPage={page.currentPage}
            totalPages={page.lastPage}
            baseUrl="/news"
            prevUrl={page.url.prev}
            nextUrl={page.url.next}
          />
        </>
      ) : (
        <p>No news articles found.</p>
      )
    }
  </main>
</Layout>
