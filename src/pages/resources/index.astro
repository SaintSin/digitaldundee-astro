---
import { getCollection } from 'astro:content';
import Breadcrumbs from '@components/Breadcrumbs.astro';
import ResourceCard from '@components/cards/Resource.astro';
import Pagination from '@components/Pagination.astro';
import Layout from '@layouts/BaseLayout.astro';
import type { CollectionPage } from '@types';
import { DEFAULT_PAGE_SIZE, getPaginatedMeta } from '@utils/pagination';
import {
  BREADCRUMB_LABELS,
  digitalDundeeOrganization,
  generateBreadcrumbs,
} from '@utils/schema';

const resources = await getCollection('resources');

import Hero from '@components/Hero.astro';
import header from '@images/header/resources.jpg';

// Sort resources alphabetically by name
const sortedResources = resources.sort((a, b) =>
  a.data.name.localeCompare(b.data.name),
);

// Paginate manually for the first page
const totalPages = Math.ceil(sortedResources.length / DEFAULT_PAGE_SIZE);
const firstPageData = sortedResources.slice(0, DEFAULT_PAGE_SIZE);

const collectionPageSchema: CollectionPage = {
  '@context': 'https://schema.org',
  '@type': 'CollectionPage',
  name: 'Resources',
  description:
    'Discover useful resources, organizations, and networks in Digital Dundee',
  url: `${digitalDundeeOrganization.url}/resources`,
  breadcrumb: generateBreadcrumbs(Astro.url.pathname, BREADCRUMB_LABELS),
};

const meta = {
  ...getPaginatedMeta(
    'Resources',
    'Discover useful resources, organizations, and networks in Digital Dundee',
    1,
    'generic-social-1200x630.png',
    'Digital Dundee Resources',
  ),
  schema: [digitalDundeeOrganization, collectionPageSchema],
};
---

<Layout metaData={meta}>
  <Hero title="Resources" image={header} alt="Resources page header" />

  <main class="wrapper flow">
    <Breadcrumbs />

    {
      firstPageData.length > 0 ? (
        <>
          <section class="grid" data-layout="thirds">
            {firstPageData.map((resource) => (
              <ResourceCard
                name={resource.data.name}
                description={resource.data.description}
                resourceUrl={resource.data.resourceUrl}
                imageSrc={resource.data.imagePrimary?.src}
                imageAlt={resource.data.imagePrimary?.alt || resource.data.name}
                href={`/resources/${resource.id}`}
              />
            ))}
          </section>

          {totalPages > 1 && (
            <Pagination
              currentPage={1}
              totalPages={totalPages}
              baseUrl="/resources"
              nextUrl={totalPages > 1 ? '/resources/2' : undefined}
            />
          )}
        </>
      ) : (
        <p>No resources found.</p>
      )
    }
  </main>
</Layout>
