---
import { getCollection } from 'astro:content';
import Breadcrumbs from '@components/Breadcrumbs.astro';
import CompanySearchFilter from '@components/CompanySearchFilter.astro';
import CompanyCard from '@components/cards/Company.astro';
import Hero from '@components/Hero.astro';
import Pagination from '@components/Pagination.astro';
import header from '@images/header/companies.jpg';
import Layout from '@layouts/BaseLayout.astro';

import { getUniqueSectors, getUniqueServiceAreas } from '@utils/companyFilters';
import {
  DEFAULT_PAGE_SIZE,
  getPaginatedMeta,
  sortByTitle,
} from '@utils/pagination';

// Switch to server-side rendering to support dynamic filtering
export const prerender = false;

const companies = await getCollection('companies');
const sortedCompanies = sortByTitle(companies);

// Extract filter values from URL
const sector = Astro.url.searchParams.get('sector');
const serviceArea = Astro.url.searchParams.get('serviceArea');
const keyword = Astro.url.searchParams.get('keyword');
const currentPage = parseInt(Astro.url.searchParams.get('page') || '1', 10);

// Filter companies based on search parameters
let filteredCompanies = sortedCompanies;

if (sector) {
  filteredCompanies = filteredCompanies.filter((company) =>
    company.data.sector?.includes(sector),
  );
}

if (serviceArea) {
  filteredCompanies = filteredCompanies.filter((company) =>
    company.data.serviceArea?.includes(serviceArea),
  );
}

if (keyword) {
  const lowerKeyword = keyword.toLowerCase();
  filteredCompanies = filteredCompanies.filter((company) =>
    company.data.title.toLowerCase().includes(lowerKeyword),
  );
}

// Manual pagination
const totalPages = Math.ceil(filteredCompanies.length / DEFAULT_PAGE_SIZE);
const startIndex = (currentPage - 1) * DEFAULT_PAGE_SIZE;
const endIndex = startIndex + DEFAULT_PAGE_SIZE;
const pageData = filteredCompanies.slice(startIndex, endIndex);

// Get unique values for filter dropdowns
const uniqueSectors = getUniqueSectors(companies);
const uniqueServiceAreas = getUniqueServiceAreas(companies);

const meta = getPaginatedMeta(
  'Meet Companies',
  'Discover the innovative companies in Digital Dundee',
  currentPage,
  'generic-social-1200x630.png',
  'Digital Dundee Companies',
);

// Helper function to build pagination URLs with current filters
function buildPaginationUrl(page: number): string {
  const params = new URLSearchParams();
  if (sector) params.set('sector', sector);
  if (serviceArea) params.set('serviceArea', serviceArea);
  if (keyword) params.set('keyword', keyword);
  if (page > 1) params.set('page', String(page));

  const queryString = params.toString();
  return queryString ? `/meet-companies?${queryString}` : '/meet-companies';
}
---

<Layout metaData={meta}>
  <Hero
    title="Meet The Companies"
    image={header}
    alt="Meet the companies page header"
  />

  <main class="wrapper flow">
    <Breadcrumbs
      customLabels={{
        'meet-companies': 'Meet The Companies',
      }}
    />
    <h1>Meet The Companies</h1>

    <CompanySearchFilter
      sectors={uniqueSectors}
      serviceAreas={uniqueServiceAreas}
    />

    {
      filteredCompanies.length > 0 ? (
        <>
          <p class="results-count">
            {filteredCompanies.length === sortedCompanies.length
              ? `Showing all ${filteredCompanies.length} companies`
              : `Found ${filteredCompanies.length} ${filteredCompanies.length === 1 ? 'company' : 'companies'}`}
          </p>

          <section class="grid" data-layout="fourths">
            {pageData.map((company) => (
              <CompanyCard
                name={company.data.title}
                companyUrl={company.data.companyUrl || ''}
                imageSrc={company.data.logo?.src}
                imageAlt={company.data.logo?.alt || company.data.title}
                href={`/meet-companies/${company.id}`}
              />
            ))}
          </section>

          {totalPages > 1 && (
            <Pagination
              currentPage={currentPage}
              totalPages={totalPages}
              baseUrl="/meet-companies"
              prevUrl={
                currentPage > 1
                  ? buildPaginationUrl(currentPage - 1)
                  : undefined
              }
              nextUrl={
                currentPage < totalPages
                  ? buildPaginationUrl(currentPage + 1)
                  : undefined
              }
            />
          )}
        </>
      ) : (
        <p>No companies found matching your search criteria.</p>
      )
    }
  </main>
</Layout>

<style>
  .results-count {
    margin-block-end: 1rem;
    color: var(--color-text-muted, #666);
    font-style: italic;
  }
</style>
