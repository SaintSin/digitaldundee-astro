---
import { getCollection } from 'astro:content';
import CompanyCard from '@components/cards/Company.astro';
import Pagination from '@components/Pagination.astro';
import Layout from '@layouts/BaseLayout.astro';
import {
  DEFAULT_PAGE_SIZE,
  getPaginatedMeta,
  sortByTitle,
} from '@utils/pagination';

// Handle old query parameter URLs by redirecting to new format
const pageParam = Astro.url.searchParams.get('page');
if (pageParam && pageParam !== '1') {
  return Astro.redirect(`/meet-companies/${pageParam}`, 301);
}

const companies = await getCollection('companies');
const sortedCompanies = sortByTitle(companies);

// Paginate manually for the first page
const totalPages = Math.ceil(sortedCompanies.length / DEFAULT_PAGE_SIZE);
const firstPageData = sortedCompanies.slice(0, DEFAULT_PAGE_SIZE);

const meta = getPaginatedMeta(
  'Meet Companies',
  'Discover the innovative companies in Digital Dundee',
  1,
  'generic-social-1200x630.png',
  'Digital Dundee Companies',
);
---

<Layout metaData={meta}>
  <main class="wrapper flow">
    <h1>Meet Companies</h1>

    {
      firstPageData.length > 0 ? (
        <>
          <section class="grid">
            {firstPageData.map((company) => (
              <CompanyCard
                name={company.data.title}
                companyUrl={company.data.companyUrl || ''}
                imageSrc={company.data.logo?.src}
                imageAlt={company.data.logo?.alt || company.data.title}
                href={`/meet-companies/${company.id}`}
              />
            ))}
          </section>

          {totalPages > 1 && (
            <Pagination
              currentPage={1}
              totalPages={totalPages}
              baseUrl="/meet-companies"
              nextUrl={totalPages > 1 ? '/meet-companies/2' : undefined}
            />
          )}
        </>
      ) : (
        <p>No companies found.</p>
      )
    }
  </main>
</Layout>

<style>
  .grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 2rem;
    margin-block: 2rem;
  }

  @media (max-width: 768px) {
    .grid {
      grid-template-columns: 1fr;
    }
  }
</style>
