---
// @components/page/HeaderNav.astro
import { Icon } from 'astro-icon/components';

const { pathname } = Astro.url;

// Helper function to check if link is in current path
const isInPath = (href: string) => {
  // Remove trailing slashes for comparison
  const cleanHref = href.replace(/\/$/, '');
  const cleanPathname = pathname.replace(/\/$/, '');

  // Don't match root path unless it's exact
  if (cleanHref === '') return cleanPathname === '';

  // Check if pathname starts with the href
  return cleanPathname.startsWith(cleanHref);
};

const links = [
  { label: 'Home', href: '/' },
  { label: 'About', href: '/about/' },
  {
    label: 'Be Dundee',
    href: '/be-dundee/',
    children: [
      { label: 'Dummy Link 1', href: '/be-dundee/link1/' },
      { label: 'Dummy Link 2', href: '/be-dundee/link2/' },
    ],
  },
  {
    label: 'Tay5G',
    href: '/tay5g/',
    children: [
      { label: 'Dummy Link 1', href: '/tay5g/link1/' },
      { label: 'Dummy Link 2', href: '/tay5g/link2/' },
    ],
  },
  { label: 'Resources', href: '/resources/' },
  { label: 'News', href: '/news/' },
  { label: 'Events', href: '/events/' },
  { label: 'Meet The Companies', href: '/meet-companies/' },
  { label: 'Success Stories', href: '/success-stories/' },
  { label: 'Contact Us', href: '/contact/' },
];
---

<nav class="main-nav">
  <button
    type="button"
    class="menu-toggle"
    aria-label="Toggle menu"
    aria-expanded="false"
  >
    <Icon name="ri:menu-line" class="icon-open" />
    <Icon name="ri:close-line" class="icon-close" />
  </button>

  <div class="nav-links">
    {
      links.map((link) => {
        const isExact = pathname === link.href;
        const isPath = isInPath(link.href);

        if (link.children) {
          // Link with dropdown
          return (
            <div class="nav-item has-dropdown">
              <a
                class:list={[
                  { 'active--exact': isExact },
                  { 'active--path': isPath && !isExact },
                ]}
                href={link.href}
              >
                {link.label}
                <Icon name="ri:arrow-down-s-line" class="dropdown-icon" />
              </a>
              <div class="dropdown-menu">
                {link.children.map((child) => (
                  <a
                    href={child.href}
                    class:list={[
                      { 'active--exact': pathname === child.href },
                      {
                        'active--path':
                          isInPath(child.href) && pathname !== child.href,
                      },
                    ]}
                  >
                    {child.label}
                  </a>
                ))}
              </div>
            </div>
          );
        } else {
          // Regular link
          return (
            <a
              class:list={[
                { 'active--exact': isExact },
                { 'active--path': isPath && !isExact },
              ]}
              href={link.href}
            >
              {link.label}
            </a>
          );
        }
      })
    }
  </div>
</nav>

<script>
  function setupMobileMenu() {
    const toggle = document.querySelector('.menu-toggle');
    const nav = document.querySelector('.main-nav');
    const navLinks = document.querySelector('.nav-links');

    if (!toggle || !nav) return;

    // Toggle menu
    toggle.addEventListener('click', () => {
      const isOpen = nav.classList.toggle('mobile-menu-open');
      toggle.setAttribute('aria-expanded', String(isOpen));
    });

    // Close menu when clicking a link
    navLinks?.addEventListener('click', (e) => {
      if ((e.target as HTMLElement).tagName === 'A') {
        nav.classList.remove('mobile-menu-open');
        toggle.setAttribute('aria-expanded', 'false');
      }
    });

    // Close menu on escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && nav.classList.contains('mobile-menu-open')) {
        nav.classList.remove('mobile-menu-open');
        toggle.setAttribute('aria-expanded', 'false');
      }
    });
  }

  // Run on initial load
  document.addEventListener('DOMContentLoaded', setupMobileMenu);

  // Run after view transitions
  document.addEventListener('astro:after-swap', setupMobileMenu);
</script>

<style>
  .main-nav {
    position: relative;
    container-name: nav;
    container-type: inline-size;
  }

  /* Menu toggle button - hidden on desktop */
  .menu-toggle {
    display: none;
    position: relative;
    z-index: 101;
    cursor: pointer;
    border: none;
    background: transparent;
    padding: var(--space-2xs);
    color: black;
    font-size: var(--step-2);

    @container nav (width < 768px) {
      display: block;
    }

    .icon-close {
      display: none;
    }
  }

  /* Show close icon when menu is open */
  .mobile-menu-open .menu-toggle {
    .icon-open {
      display: none;
    }
    .icon-close {
      display: block;
    }
  }

  /* Navigation links container */
  .nav-links {
    display: inline-flex;
    flex-wrap: wrap;
    align-items: center;
    gap: var(--space-s);

    /* Mobile: full screen overlay */
    @container nav (width < 768px) {
      display: none;
      position: fixed;
      flex-direction: column;
      align-items: stretch;
      gap: 0;
      z-index: 100;
      inset: 0;
      background: white;
      padding: var(--space-3xl) var(--space-s) var(--space-s);
      overflow-y: auto;

      .mobile-menu-open & {
        display: flex;
      }
    }

    /* Base link styles */
    a {
      padding: var(--space-2xs);
      color: black;
      font-weight: 500;
      font-size: var(--step--2);
      font-family: var(--font-montserrat);
      letter-spacing: 1px;
      text-decoration: none;
      text-transform: uppercase;
      white-space: nowrap;

      &:hover {
        text-decoration: underline;
        text-decoration-thickness: 2px;
        text-underline-offset: var(--space-3xs);
      }

      /* Mobile: larger, block-level links */
      @container nav (width < 768px) {
        border-bottom: 1px solid var(--gray-2);
        padding: var(--space-s);
        font-size: var(--step-0);
        white-space: normal;

        &:hover {
          background: var(--gray-1);
          text-decoration: none;
        }
      }
    }

    .active--exact {
      text-decoration: underline;
      text-decoration-thickness: 2px;
      text-underline-offset: var(--space-3xs);

      @container nav (width < 768px) {
        background: var(--gray-2);
        font-weight: 600;
        text-decoration: none;
      }
    }

    .active--path {
      text-decoration: underline;
      text-decoration-thickness: 2px;
      text-underline-offset: var(--space-3xs);

      @container nav (width < 768px) {
        font-weight: 600;
        text-decoration: none;
      }
    }
  }

  /* Navigation items */
  .nav-item {
    display: inline-flex;
    position: relative;
    align-items: center;

    /* Mobile: full width blocks */
    @container nav (width < 768px) {
      flex-direction: column;
      align-items: stretch;
      border-bottom: 2px solid var(--gray-3);

      > a {
        border-bottom: 1px solid var(--gray-3);
        background: var(--gray-1);
        font-weight: 600;
      }
    }
  }

  /* Dropdown items */
  .nav-item.has-dropdown > a {
    display: inline-flex;
    align-items: center;
    gap: var(--space-3xs);
  }

  .dropdown-icon {
    transition: transform 0.2s ease;
    font-size: var(--step-0);

    /* Desktop: rotate on hover */
    .nav-item.has-dropdown:hover &,
    .nav-item.has-dropdown:focus-within & {
      @container nav (width >= 768px) {
        transform: rotate(180deg);
      }
    }

    /* Mobile: hide icon */
    @container nav (width < 768px) {
      display: none;
    }
  }

  /* Dropdown menu */
  .dropdown-menu {
    display: flex;
    flex-direction: column;
    gap: 0;
    padding: 0;

    /* Desktop: positioned dropdown */
    @container nav (width >= 768px) {
      position: absolute;
      top: 100%;
      left: 0;
      transform: translateY(calc(-1 * var(--space-xs)));
      visibility: hidden;

      /* Hidden by default */
      opacity: 0;
      z-index: 100;
      transition:
        opacity 0.2s ease,
        visibility 0.2s ease,
        transform 0.2s ease;
      margin-top: var(--space-2xs);
      box-shadow: var(--shadow-3);
      border: 1px solid var(--gray-4);
      border-radius: var(--radius-2);
      background: white;
      min-width: 12rem;

      /* Show on hover or focus */
      .nav-item.has-dropdown:hover &,
      .nav-item.has-dropdown:focus-within & {
        transform: translateY(0);
        visibility: visible;
        opacity: 1;
      }
    }

    /* Mobile: always visible, stacked */
    @container nav (width < 768px) {
      position: static;
      transform: none;
      visibility: visible;
      opacity: 1;
      box-shadow: none;
      border: none;
    }

    a {
      padding: var(--space-xs) var(--space-s);
      color: black;
      font-size: var(--step--1);
      font-family: var(--font-montserrat);
      letter-spacing: 0.5px;
      text-decoration: none;
      text-transform: none;
      white-space: nowrap;

      /* Desktop: dropdown styling */
      @container nav (width >= 768px) {
        border-bottom: 1px solid var(--gray-2);

        &:first-child {
          border-radius: var(--radius-2) var(--radius-2) 0 0;
        }

        &:last-child {
          border-bottom: none;
          border-radius: 0 0 var(--radius-2) var(--radius-2);
        }

        &:hover,
        &:focus {
          outline: none;
          background: var(--gray-1);
        }

        &.active--exact {
          background: var(--gray-2);
          font-weight: 600;
        }
      }

      /* Mobile: indented sub-links */
      @container nav (width < 768px) {
        border-bottom: 1px solid var(--gray-2);
        padding: var(--space-s) var(--space-s) var(--space-s) var(--space-l);
        text-transform: uppercase;

        &:hover {
          background: var(--gray-1);
        }

        &.active--exact {
          background: var(--gray-2);
          font-weight: 600;
        }
      }
    }
  }
</style>
